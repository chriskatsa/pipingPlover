{"ts":1349180694386,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"dojo.require(\"esri.map\");\r\ndojo.require(\"esri.dijit.Legend\");\r\ndojo.require(\"esri.dijit.Scalebar\");\r\ndojo.require(\"esri.arcgis.utils\");\r\ndojo.require(\"esri.IdentityManager\");\r\ndojo.require(\"dijit.dijit\"); // optimize: load dijit layer\r\ndojo.require(\"dijit.layout.BorderContainer\");\r\ndojo.require(\"dijit.layout.ContentPane\");\r\n\r\nvar urlObject,\r\n    map,\r\n    section = 0,\r\n    popup,\r\n    setPopup = true,\r\n    iPad = false,\r\n    seasonExtent;\r\n\r\nvar findLayerName = function(name){\r\n    var layerName;\r\n    dojo.forEach(map.layerIds,function(lyr){\r\n        if(lyr.search(name) !== -1){\r\n            layerName = lyr;\r\n        }\r\n    });\r\n    dojo.forEach(map.graphicsLayerIds,function(lyr){\r\n        if(lyr.search(name) !== -1){\r\n            layerName = lyr;\r\n        }\r\n    });\r\n    return layerName;\r\n};\r\n\r\nvar initMap = function(){\r\n\r\n    if(configOptions.geometryserviceurl && location.protocol === \"https:\"){\r\n        configOptions.geometryserviceurl = configOptions.geometryserviceurl.replace('http:','https:');\r\n    }\r\n    esri.config.defaults.geometryService = new esri.tasks.GeometryService(configOptions.geometryserviceurl);\r\n\r\n    if(!configOptions.sharingurl){\r\n        configOptions.sharingurl = location.protocol + '//' + location.host + \"/sharing/content/items\";\r\n    }\r\n    esri.arcgis.utils.arcgisUrl = configOptions.sharingurl;\r\n\r\n    urlObject = esri.urlToObject(document.location.href);\r\n    urlObject.query = urlObject.query || {};\r\n\r\n    if(urlObject.query.season){\r\n        if(urlObject.query.season.toLowerCase() === \"summer\"){\r\n            section = 1;\r\n        }\r\n        else if(urlObject.query.season.toLowerCase() === \"fall\"){\r\n            section = 2;\r\n        }\r\n        else if(urlObject.query.season.toLowerCase() === \"winter\"){\r\n            section = 3;\r\n        }\r\n        else if(urlObject.query.season.toLowerCase() === \"spring\"){\r\n            section = 4;\r\n        }\r\n        else{\r\n            section = 0;\r\n        }\r\n    }\r\n\r\n    createMap();\r\n\r\n    $(\"title\").html(configOptions.title);\r\n    $(\"#title\").html(configOptions.title);\r\n    $(\"#subtitle\").html(configOptions.subtitle);\r\n\r\n};\r\n\r\nvar createMap = function(){\r\n\r\n    var lods = [\r\n      \t{\"level\" : 0, \"resolution\" : 9783.93962049996, \"scale\" : 36978595.474472},\r\n  \t\t{\"level\" : 1, \"resolution\" : 4891.96981024998, \"scale\" : 18489297.737236},\r\n        {\"level\" : 2, \"resolution\" : 2445.98490512499, \"scale\" : 9244648.868618},\r\n        {\"level\" : 3, \"resolution\" : 1222.99245256249, \"scale\" : 4622324.434309},\r\n      \t{\"level\" : 4, \"resolution\" : 611.49622628138, \"scale\" : 2311162.217155},\r\n        {\"level\" : 5, \"resolution\" : 305.748113140558, \"scale\" : 1155581.108577},\r\n        {\"level\" : 6, \"resolution\" : 152.874056570411, \"scale\" : 577790.554289}\r\n    ];\r\n\r\n    popup = new esri.dijit.Popup({\r\n        highlight:false\r\n    }, dojo.create(\"div\"));\r\n\r\n    var mapDeferred = esri.arcgis.utils.createMap(configOptions.webmap,\"map\",{\r\n        mapOptions: {\r\n            slider : false,\r\n            nav : false,\r\n            wrapAround180 : true,\r\n            infoWindow : popup,\r\n            lods : lods\r\n        },\r\n        ignorePopups:true\r\n    });\r\n\r\n    mapDeferred.addCallback(function(response){\r\n        map = response.map;\r\n\r\n        dojo.connect(dijit.byId(\"map\"),\"resize\",map,map.resize);\r\n\r\n        dojo.connect(map.getLayer(findLayerName(\"csv\")),\"onMouseOver\",function(event){\r\n            if(iPad === false){\r\n                map.setCursor(\"pointer\");\r\n                $(\"#hoverInfo\").html(event.graphic.attributes.Site_title);\r\n                positionInfo(event.graphic.geometry,$(\"#hoverInfo\"),$(\"#hoverInfoArrow\"));\r\n            }\r\n            else{\r\n                $(\".contentSlide\").each(function(){\r\n                    if($(this).children(\".titleBar\").children(\"tbody\").children(\"tr\").children(\".popupTitle\").html() === event.graphic.attributes.Point_name){\r\n                        $(\".contentSlide\").removeClass(\"currentSlide\");\r\n                        $(this).addClass(\"currentSlide\");\r\n                        $(\"#contentSlider\").animate({\r\n                            \"left\" : -$(\".currentSlide\").position().left\r\n                        },\"fast\");\r\n                        map.centerAndZoom(event.graphic.geometry,3);\r\n                    }\r\n                });\r\n            }\r\n        });\r\n\r\n        dojo.connect(map.getLayer(findLayerName(\"csv\")),\"onMouseOut\",function(event){\r\n            map.setCursor(\"default\");\r\n            hideInfo($(\"#hoverInfo\"),$(\"#hoverInfoArrow\"));\r\n        });\r\n\r\n        dojo.connect(map.getLayer(findLayerName(\"csv\")),\"onClick\",function(event){\r\n            if(iPad === false){\r\n                $(\".contentSlide\").each(function(){\r\n                    if($(this).children(\".titleBar\").children(\"tbody\").children(\"tr\").children(\".popupTitle\").html() === event.graphic.attributes.Point_name){\r\n                        $(\".contentSlide\").removeClass(\"currentSlide\");\r\n                        $(this).addClass(\"currentSlide\");\r\n                        $(\"#contentSlider\").animate({\r\n                            \"left\" : -$(\".currentSlide\").position().left\r\n                        },\"fast\");\r\n                        map.centerAndZoom(event.graphic.geometry,3);\r\n                    }\r\n                });\r\n            }\r\n        });\r\n\r\n        dojo.connect(map,\"onPanStart\",function(){\r\n            hideInfo($(\"#hoverInfoSlide\"),$(\"#hoverInfoArrowSlide\"));\r\n            hideInfo($(\"#hoverInfo\"),$(\"#hoverInfoArrow\"));\r\n        });\r\n\r\n        dojo.connect(map,\"onZoomStart\",function(){\r\n            hideInfo($(\"#hoverInfoSlide\"),$(\"#hoverInfoArrowSlide\"));\r\n            hideInfo($(\"#hoverInfo\"),$(\"#hoverInfoArrow\"));\r\n        });\r\n\r\n        dojo.connect(map,\"onExtentChange\",function(){\r\n            var title = $(\".currentSlide\").children(\".titleBar\").children(\"tbody\").children(\"tr\").children(\".popupTitle\").html();\r\n            dojo.forEach(map.getLayer(findLayerName(\"csv\")).graphics,function(grp){\r\n                if (grp.attributes.Point_name === title){\r\n                    $(\"#hoverInfoSlide\").html(grp.attributes.Site_title);\r\n                    positionInfo(grp.geometry,$(\"#hoverInfoSlide\"),$(\"#hoverInfoArrowSlide\"));\r\n                }\r\n            });\r\n            if($(\".currentSlide\").first().hasClass(\"popupSlide\")){\r\n                $(\".popup.fader\").imageFader(\"pause\");\r\n                $(\".currentSlide\").first().children(\".fader\").first().imageFader(\"play\");\r\n            }\r\n        });\r\n\r\n        dojo.connect(map,\"onUpdateEnd\",function(){\r\n            $(\"#loadingModal\").fadeOut();\r\n            $(\"#thumbnail\").hide();\r\n        });\r\n\r\n        //var layers = response.itemInfo.itemData,operationalLayers;\r\n\r\n        if(map.loaded){\r\n            setSection(section);\r\n            changeSidePanel();\r\n            $(\"#zoomToggle\").show();\r\n        }\r\n        else{\r\n            dojo.connect(map,\"onLoad\",function(){\r\n                setSection(section);\r\n                changeSidePanel();\r\n                $(\"#zoomToggle\").show();\r\n            });\r\n        }\r\n\r\n    });\r\n    mapDeferred.addErrback(function(error) {\r\n        console.log(\"Map creation failed: \", dojo.toJson(error));\r\n    });\r\n\r\n    dojo.connect(popup,\"onSetFeatures\",function(){\r\n        if(section !== 0){\r\n            var newFtr = [];\r\n            dojo.forEach(popup.features,function(ftr){\r\n                if(ftr.attributes.Season === section){\r\n                    newFtr.push(ftr);\r\n                }\r\n            });\r\n            if (setPopup === true){\r\n                setPopup = false;\r\n                popup.setFeatures(newFtr);\r\n            }\r\n            else{\r\n                setPopup = true;\r\n            }\r\n        }\r\n        else{\r\n            //$(\".actionList\").html(\"<p id='seasonButton'>Go to \"+popup.features[0].attributes.Season+\"</p>\");\r\n        }\r\n    });\r\n\r\n};"]],"start1":0,"start2":0,"length1":0,"length2":7839}]],"length":7839}
{"contributors":[],"silentsave":true,"ts":1349272551233,"patch":[[{"diffs":[[0,"577}"],[-1,",\r\n        {\"level\" : 6, \"resolution\" : 152.874056570411, \"scale\" : 577790.554289}"],[0,"\r\n  "]],"start1":2666,"start2":2666,"length1":90,"length2":8},{"diffs":[[0,"        "],[-1,"//"],[0,"var laye"]],"start1":6542,"start2":6542,"length1":18,"length2":16},{"diffs":[[0,"itemData"],[-1,","],[1,"."],[0,"operatio"]],"start1":6581,"start2":6581,"length1":17,"length2":17},{"diffs":[[0,"p.loaded){\r\n"],[1,"            initUI(layers);\r\n"],[0,"            "]],"start1":6625,"start2":6625,"length1":24,"length2":53},{"diffs":[[0,"d\",function(){\r\n"],[1,"                initUI(layers);\r\n"],[0,"                "]],"start1":6831,"start2":6831,"length1":32,"length2":65},{"diffs":[[0,"}\r\n    });\r\n\r\n};"],[-1,""],[0,""],[1,"\r\n\r\n\r\nfunction initUI(layers) {\r\n\r\n    var layerInfo = buildLayersList(layers);\r\n\r\n    if(layerInfo.length > 0){\r\n    \tvar legendDijit = new esri.dijit.Legend({\r\n\t\t\tmap:map,\r\n\t\t\tlayerInfos:layerInfo\r\n\t\t},\"legendContent\");\r\n        legendDijit.startup();\r\n    }\r\n    else{\r\n        dojo.byId(\"legendContent\").innerHTML = \"\";\r\n    }\r\n}\r\n\r\nfunction buildLayersList(layers){\r\n        //layers  arg is  response.itemInfo.itemData.operationalLayers;\r\n        var layerInfos = [];\r\n        dojo.forEach(layers, function(mapLayer, index){\r\n          var layerInfo = {};\r\n          if (mapLayer.featureCollection && mapLayer.type !== \"CSV\") {\r\n            if (mapLayer.featureCollection.showLegend === true) {\r\n              dojo.forEach(mapLayer.featureCollection.layers, function(fcMapLayer){\r\n                if (fcMapLayer.showLegend !== false) {\r\n                  layerInfo = {\r\n                    \"layer\": fcMapLayer.layerObject,\r\n                    \"title\": mapLayer.title,\r\n                    \"defaultSymbol\": false\r\n                  };\r\n                  if (mapLayer.featureCollection.layers.length > 1) {\r\n                    layerInfo.title += \" - \" + fcMapLayer.layerDefinition.name;\r\n                  }\r\n                  layerInfos.push(layerInfo);\r\n                }\r\n              });\r\n            }\r\n          } else if (mapLayer.showLegend !== false) {\r\n            layerInfo = {\r\n              \"layer\": mapLayer.layerObject,\r\n              \"title\": mapLayer.title,\r\n              \"defaultSymbol\": false\r\n            };\r\n            //does it have layers too? If so check to see if showLegend is false\r\n            if (mapLayer.layers) {\r\n              var hideLayers = dojo.map(dojo.filter(mapLayer.layers, function(lyr){\r\n                return (lyr.showLegend === false);\r\n              }), function(lyr){\r\n                return lyr.id\r\n              });\r\n              if (hideLayers.length) {\r\n                layerInfo.hideLayers = hideLayers;\r\n              }\r\n            }\r\n            layerInfos.push(layerInfo);\r\n          }\r\n        });\r\n        return layerInfos;\r\n      }"]],"start1":7801,"start2":7801,"length1":16,"length2":2118}]],"length":9919,"saved":false}
{"ts":1349272581276,"patch":[[{"diffs":[[0,"155}"],[-1,",\r\n        {\"level\" : 5, \"resolution\" : 305.748113140558, \"scale\" : 1155581.108577}"],[0,"\r\n  "]],"start1":2583,"start2":2583,"length1":91,"length2":8}]],"length":9836,"saved":false}
{"ts":1349272593786,"patch":[[{"diffs":[[0,".217155}"],[1,",\r\n        {\"level\" : 5, \"resolution\" : 305.748113140558, \"scale\" : 1155581.108577}"],[0,"\r\n    ];"]],"start1":2579,"start2":2579,"length1":16,"length2":99}]],"length":9919,"saved":false}
{"contributors":[],"silentsave":true,"ts":1349467984582,"patch":[[{"diffs":[[0,"e{\r\n        "],[1,"//"],[0,"dojo.byId(\"l"]],"start1":8086,"start2":8086,"length1":24,"length2":26}]],"length":9921,"saved":false}
{"ts":1349467988273,"patch":[[{"diffs":[[0,"        "],[-1,"//"],[0,"dojo.byI"]],"start1":8090,"start2":8090,"length1":18,"length2":16}]],"length":9919,"saved":false}
{"ts":1349467990146,"patch":[[{"diffs":[[0,"\n    }\r\n"],[1,"    \r\n"],[0,"}\r\n\r\nfun"]],"start1":8141,"start2":8141,"length1":16,"length2":22}]],"length":9925,"saved":false}
{"ts":1349467991093,"patch":[[{"diffs":[[0," }\r\n    "],[1,"/"],[0,"\r\n}\r\n\r\nf"]],"start1":8145,"start2":8145,"length1":16,"length2":17}]],"length":9926,"saved":false}
{"ts":1349467991890,"patch":[[{"diffs":[[0," }\r\n    "],[-1,"/"],[0,"\r\n}\r\n\r\nf"]],"start1":8145,"start2":8145,"length1":17,"length2":16}]],"length":9925,"saved":false}
{"ts":1349467993491,"patch":[[{"diffs":[[0," }\r\n    "],[1,"*/"],[0,"\r\n}\r\n\r\nf"]],"start1":8145,"start2":8145,"length1":16,"length2":18}]],"length":9927,"saved":false}
{"ts":1349467996158,"patch":[[{"diffs":[[0,"layers);\r\n\r\n"],[1,"    \r\n"],[0,"    if(layer"]],"start1":7888,"start2":7888,"length1":24,"length2":30}]],"length":9933,"saved":false}
{"ts":1349467998008,"patch":[[{"diffs":[[0,"\r\n\r\n    "],[1,"*/"],[0,"\r\n    if"]],"start1":7896,"start2":7896,"length1":16,"length2":18}]],"length":9935,"saved":false}
{"ts":1349468000214,"patch":[[{"diffs":[[0,"\r\n\r\n    "],[-1,"*"],[0,"/"],[1,"*"],[0,"\r\n    if"]],"start1":7896,"start2":7896,"length1":18,"length2":18}]],"length":9935,"saved":false}
